---
title: "数据库基础知识"
author: ""
date: "2020-03"
output:
  bookdown::html_document2:
    number_sections: true
    seq_numbering: true
    fig_caption: true
    highlight: haddock
    theme: null
    md_extensions: +east_asian_line_breaks
    keep_md: true
    toc: true
    pandoc_args: ["--filter", "pandoc-crossref", "-M", "eqnPrefix="]
  bookdown::word_document2:
    fig_caption: true
    reference_docx: ./style/word-styles-02.docx
    md_extensions: +east_asian_line_breaks
    pandoc_args: ["--filter", "pandoc-crossref"]
  bookdown::pdf_document2:
    keep_tex: yes
    toc: true
    latex_engine: xelatex
    md_extensions: +east_asian_line_breaks
    pandoc_args: ["--listing", "--filter", "pandoc-crossref"]
css: ./style/markdown.css
autoEqnLabels: true
eqnPrefixTemplate: ($$i$$)
linkReferences: true
bibliography: Bibfile.bib
csl: ./style/chinese-gb7714-2005-numeric.csl
link-citations: true
---

```{r setup, echo=F, purl=F}
knitr::opts_knit$set(root.dir = getwd())
knitr::opts_chunk$set(echo = TRUE, results = 'hide')
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
knitr::opts_chunk$set(fig.align="center"
                      ## ,out.width="0.9\\textwidth" # latex
                      ,out.width="60%" # for both latex and html
                      ,fig.width=5, fig.height=3
                      )
```

```{r prepare, echo=F, purl=F}
rm(list=ls())
options(digits=4)
options(scipen=100)
graphics.off()
Sys.setlocale("LC_ALL", "Chinese")
```

# 关系数据库
## 关系数据结构及形式化定义
### 关系

1. 域
   
   **域**是一组具有相同数据类型的值得集合。例如整数、实数、长度小于25字节的字符
   串集合、{0， 1}等。

2. 笛卡尔积
   
   给定一组域$D_1$,$D_2$,$D_3$,...,$D_n$,这些域中可以是相同的域。$D_1$,$D_2$,$D_3$,...,$D_n$的**笛卡尔积**为：
   $$D_{1}\times D_{2}\times \cdots \times D_{n}=\left \{  \right (d_1,d_2,\cdots, d_n)|d_j\in D_j, i=1, 2, \cdots,n\}$$
   其中每一个元素叫做一个**n元组**或简称**元组**。
   元素中每一个值$d_i$叫做一个**分量**。
   若$D_i(i=1,2,...,n)$为有限集，其基数为$m_i(i=1,2,...,n)$，则的基数M为：
   $$M=\prod_{i=1}^{n}m_i$$
   笛卡尔积可表示为一个二维表，表中的每行对应一个元组，表中的每列对于一个域.

3. 关系
   - 关系：$D_{1}\times D_{2}\times \cdots \times D_{n}$的子集叫做在域$D_1$,$D_2$,$D_3$,...,$D_n$上的关系，表示为$R(D_1,D_2,\cdots ,D_n)$。这里的R代表关系名，n是关系的**目或度**
   - 元组： 关系中的每个元素是关系中的元组，通常用t表示。
   - 单元关系与二元关系：当n=1时，称该关系为单元关系，当n=2时，称该关系为二元关系
   - 属性：每列的名字，称为属性，n目关系必有n个属性
   - 码：若关系中的某一属性组的值能唯一地标识一个元组，则称该属性组为候选码；若一个关系有多个候选码，则选定其中一个为主码

### 关系模式

1. 什么是关系模式
   
  关系模式是型，关系是值，关系模式是对关系的描述。

2. 定义关系模式
   
  关系模式可以形式化的表示为：R（U, D, DOM, F)，其中R为关系名，U为组成该关系的属性名集合
   D为属性组U中属性所来自的域，DOM为属性向域的映象集合，F为属性间的数据依赖关系
   集合。
  关系模式通常简记为R(U)

3. 关系模式与关系
   
   关系模式是静态的、稳定的。关系是关系模式在某一时刻的状态或内容，是动态的、随时间不断变化的。

### 关系数据库

在一个给定的应用领域中，所有关系的集合构成一个关系数据库

关系数据库的型：关系数据库模式，对关系数据库的描述。

关系数据库的值: 关系模式在某一时刻对应的关系的集合，简称为关系数据库

## 关系操作

### 基本关系操作

- 常用的关系操作
    - 查询：选择、投影、连接、除、并、交、差
    - 数据更新：插入、删除、修改
    - 查询的表达能力是其中最主要的部分
    - 选择、投影、并、差、笛卡尔基是5种基本操作

- 关系操作的特点
    - 集合操作方式：操作的对象和结果都是集合，一次一集合的方式

### 关系数据库语言的分类

- 关系代数语言
    - 用对关系的运算来表达查询要求
    - 代表：ISBL
- 关系演算语言：用谓词来表达查询要求
    - 元组关系演算语言
        - 谓词变元的基本对象是元组变量
        - 代表：APLHA, QUEL
    - 域关系演算语言    
        - 谓词变元的基本对象是域变量
        - 代表：QBE
- 具有关系代数和关系演算双重特点的语言
    - 代表：SQL（Structured Query Language） 

## 关系代数
### 概述
关系代数是一种抽象的查询语言，它是用对关系的运算来表达查询的。

关系代数的运算对象是关系，运算结果也是关系。关系代数用到的运算符如下：

| 运算符      | 含义                      |
|----------|-------------------------|
| 集合运算符    | ∪（并）、-（差）、∩（交）、x（笛卡尔积） |
| 比较运算符    | ＞ ≥ ＜ ≤ ＝ <>            |
| 专门的关系运算符 | $\delta （选择）、\pi（投影)、\infty (连接)、\div (除)$       |
| 逻辑运算符    | $\urcorner$（非）、$\wedge$(与)、$\wedge$(或)                   |


### 传统运算符
设R和S具有相同的目n（两个关系都有n个属性），且相应的属性取自同一个域。

1. **并（Union）**

$R\cup S:$

 $$R\cup S=\{t|t\in R \vee t\in S\}$$
结果仍为n目关系，由属于R或属于S的元组组成

2. **差（Difference）**

$R-S:$

 $$R-S=\{t|t\in R \wedge t\notin S\}$$
结果仍为n目关系，由属于R而不属于S的所有元组组成


3. **交（Intersection）**

$R\cap S:$

 $$R\cap S=\{t|t\in R \wedge t\in S\}\\
 R\cap S=R-(R-S)$$

结果仍为n目关系，由既属于R又属于S的元组组成

4. **(广义）笛卡尔积（Cartesian Product）**

* R: n目关系，k1个元组
* S: m目关系，k2个元组

$R\times S$

* 列：（n+m）列元组的集合
    * 元组的前n列是关系R的一个元组
    * 后m列是关系S的一个元组
* 行：k1×k2个元组
    * $R \times S=\{\widehat{t_{r} t_{S}} | t_{r} \in R \wedge t_{S} \in S\}$

### 专门的运算关系
**记号**

1. $R,t\in R,t[A_i]$
   * 设关系模式为$R(A_1,A_2,\cdots,A_n)$,它的一个关系设为R
   * $t\in R$表示t是R的一个元组
   * $t[A_i]$则表示元组t中相应于属性Ai的一个分量

如:$t = (a1,b1,c1)\in R$, 是R的一个元组 ,$t[A_2]$ =(b1)

2. $A,t[A],\overline{A}$
    * 若$A=\{A_{i1},A_{i2},\cdots ,A_{ik}\}$，其中$A_{i1}，A_{i2},\cdots ,A_{ik}$是$A_1，A_2,\cdots ,A_n$中的一部分，则A称为属性列或属性组。
    * $t[A]=(t[A_{i1},t[A_{i2},\cdots , t[A_{ik}])$表示元组t在属性列A上诸分量的集合。
    * $\overline{A}$则表示$A_1，A_2,\cdots ,A_n$中去掉$A_{i1}，A_{i2},\cdots ,A_{ik}$后剩余的属性组。

3. $\widehat{t_{r} t_{S}}$,R为n目关系，S为m目关系,$t_{r}\in R,t_{s}\in S$
    * $\widehat{t_{r} t_{S}}$称为元组的连接。
    * $\widehat{t_{r} t_{S}}$是一个n + m列的元组，前n个分量为R中的一个n元组，后m个分量为S中的一个m元组。

如：$t_r= (a1,b1,c1)\in R,t_s= (a1,b1,c1)\in S,则\widehat{t_{r} t_{S}}=(a1,b1,c1, b1,c2,d1)$


4. $象集Z_x$
   
   给定一个关系R（X，Z），X和Z为属性组。当t[X] = x 时，x在R中的象集（Images
   Set）为：
   $$Z_x=\{t[Z]|t \in  R,t[X] = x\}$$
 它表示R中属性组X上值为x的诸元组在Z上分量的集合


如：

| $x\_1$ | $Z\_1$ |
|--------|--------|
| $x\_1$ | $Z\_2$ |
| $x\_1$ | $Z\_3$ |
| $x\_2$ | $Z\_2$ |
| $x\_2$ | $Z\_3$ |
| $x\_3$ | $Z\_1$ |
| $x\_3$ | $Z\_3$ |

- $x_1在R中的象集:Z_{x_1} ={Z_1，Z_2，Z_3}$
- $x_2在R中的象集:Z_{x_1} ={Z_2，Z_3}$
- $x_3在R中的象集:Z_{x_1} ={Z_1,Z_3}$


1. **选择（Selection）** 
   
- 选择又称为限制（Restriction）
- 选择运算符的含义：
    - 在关系R中选择满足给定条件的诸元组：$\sigma_F(R)=\{t|t\in R \wedge F(t)='真'\}$
    - F:选择条件，是一个逻辑表达式，基本形式为：$X_1 \theta Y_1$
- 选择运算是从关系R中选取使逻辑表达式F为真的元组，是从行的角度进行的运算

2. **投影（Projection）** 

- 投影运算符的含义:
    - 从R中选择出若干属性列组成新的关系$\pi_A(R)=\{t[A]|t\in R\}$,A：R中的属性列
- 投影操作主要是从列的角度进行运算
    - 但投影之后不仅取消了原关系中的某些列，而且还可能取消某些元组（避免重复行）

3. **连接（Join）** 

- 连接也称为$\theta$连接
- 连接运算的含义:
  从两个关系的笛卡尔积中选取属性间满足一定条件的元组$$R\bowtie
  S=\{\widehat{t_{r}t_{S}} | t_{r} \in R \wedge t_{S} \in S\wedge t_r[A]\theta t_s[B]\}$$
    - A和B：分别为R和S上度数相等且可比的属性组
    - $theta$:比较运算符 
- 连接运算从R和S的广义笛卡尔积R×S中选取（R关系）在A属性组上的值与（S关系）在B属性组上值满足比较关系θ的元组 
- 两类常用连接运算
    + 等值连接(equijoin):$theta$为“＝”的连接运算称为等值连接，从关系R与S的广义笛卡尔积中选取A、B属性值相等的那些元组，即等值连接为：$$R \underset{A=B}{\bowtie} S=\{\widehat{t_{r}t_{S}} | t_{r} \in R \wedge t_{S} \in S\wedge t_r[A]= t_s[B]\}$$
    + 自然连接（Natural join）:自然连接是一种特殊的等值连接,两个关系中进行比较的
      分量必须是相同的属性组,在结果中把重复的属性列去掉;R和S具有相同的属性组B
      $$R\bowtie S=\{\widehat{t_{r}t_{S}} | t_{r} \in R \wedge t_{S} \in
      S\wedge t_r[B]= t_s[B]\}$$
- 一般的连接操作是从行的角度进行运算。
    + 自然连接还需要取消重复列，所以是同时从行和列的角度进行运算。

**外连接**

如果把舍弃的元组也保存在结果关系中，而在其他属性上填空值(Null)，这种连接就叫做外连接（OUTER JOIN）。

**左外连接**

如果只把左边关系R中要舍弃的元组保留就叫做左外连接(LEFT OUTER JOIN或LEFT JOIN)

**右外连接**
****
如果只把右边关系S中要舍弃的元组保留就叫做右外连接(RIGHT OUTER JOIN或RIGHT JOIN)。 


1. **除（Division）** 
   
- 给定关系R (X，Y) 和S (Y，Z)，其中X，Y，Z为属性组。
- R中的Y与S中的Y可以有不同的属性名，但必须出自相同的域集。
- R与S的除运算得到一个新的关系P(X)，P是R中满足下列条件的元组在 X 属性列上的投影：$$R\div S=\{t_r[X]|t_{r} \in R \wedge \pi_{Y}(S)\subseteq Y_X \}\\Y_X:x在R中的象集，x=t_r[X]$$
- 除操作是同时从行和列角度进行运算

举例：

R:

| A  | B  | C  |
|----|----|----|
| a1 | b1 | c2 |
| a2 | b3 | c7 |
| a3 | b4 | c6 |
| a1 | b2 | c3 |
| a4 | b6 | c6 |
| a2 | b2 | c3 |
| a1 | b6 | c1 |

S:

| B  | C  | D  |
|----|----|----|
| b1 | c2 | d1 |
| b1 | c1 | d1 |
| b2 | c3 | d2 |

$R\div S$

| A  |
|----|
| a1 |

- 在关系R中，A可以取四个值{a1，a2，a3，a4}
    + a1的象集为 {(b1，c2)，(b2，c3)，(b2，c1)}
    + a2的象集为 {(b3，c7)，(b2，c3)}
    + a3的象集为 {(b4，c6)}
    + a4的象集为 {(b6，c6)}
- S在(B，C)上的投影为{(b1，c2)，(b2，c1)，(b2，c3) }
- 只有a1的象集包含了S在(B，C)属性组上的投影$R\div S ={a1}$
